name: iOS Build & Test

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-15  # macOS v·ªõi Xcode 16.3 (Sequoia runner)

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Xcode 16.3
      - name: Select Xcode 16.3
        run: |
          sudo xcode-select -s /Applications/Xcode_16.3.app || sudo xcode-select -s /Applications/Xcode.app
          xcodebuild -version

      # 3Ô∏è‚É£ Boot iPhone 15 simulator (iOS 17.0)
      - name: Boot iPhone 15 simulator
        run: |
          echo "üîç Checking simulator list..."
          xcrun simctl list devices | grep "iPhone 15" || true

          device_id=$(xcrun simctl list devices | grep "iPhone 15" | grep -oE "[0-9A-F-]{36}" | head -1)
          if [ -z "$device_id" ]; then
            echo "‚ùå No iPhone 15 simulator found!"
            exit 1
          fi

          echo "üü¢ Booting simulator $device_id..."
          xcrun simctl boot "$device_id" || echo "Simulator already booted"
          open -a Simulator || true

          echo "‚úÖ Simulator booted successfully!"
          xcrun simctl list devices | grep "$device_id"

      # 4Ô∏è‚É£ Install CocoaPods (n·∫øu c√≥ Podfile)
      - name: Install CocoaPods
        run: |
          if [ -f "ios/Podfile" ]; then
            cd ios && pod install
          else
            echo "No Podfile found, skipping pods install."
          fi

      # 5Ô∏è‚É£ Build iOS app
      - name: Build app
        run: |
          cd ios
          xcodebuild \
            -workspace OnlineBikeShopping.xcworkspace \
            -scheme OnlineBikeShopping \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
            clean build | xcpretty

      # 6Ô∏è‚É£ Run unit tests (optional)
      - name: Run tests
        run: |
          cd ios
          xcodebuild \
            -workspace OnlineBikeShopping.xcworkspace \
            -scheme OnlineBikeShopping \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
            test | xcpretty
