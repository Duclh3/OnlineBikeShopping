name: iOS Build & Test (Auto Device)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 16.3
        run: |
          sudo xcode-select -s /Applications/Xcode_16.3.app || sudo xcode-select -s /Applications/Xcode.app
          xcodebuild -version

      - name: Boot available iPhone 15 simulator
        id: boot
        run: |
          echo "🔍 Listing simulators..."
          xcrun simctl list devices available
          
          # Lấy simulator iPhone 15 bất kỳ đang có
          DEVICE=$(xcrun simctl list devices available | grep "iPhone 15" | head -1 | sed -E 's/.*\(([-A-F0-9]+)\).*/\1/')
          echo "✅ Using simulator ID: $DEVICE"
          echo "DEVICE_ID=$DEVICE" >> $GITHUB_ENV
          
          # Boot simulator
          xcrun simctl boot "$DEVICE" || echo "Already booted"
          open -a Simulator || true
          sleep 10

      - name: Install CocoaPods
        run: |
          if [ -f "ios/Podfile" ]; then
            cd ios && pod install
          fi

      - name: Build app
        run: |
          xcodebuild \
            -workspace OnlineBikeShopping.xcworkspace \
            -scheme OnlineBikeShopping \
            -destination "id=${DEVICE_ID}" \
            clean build | xcpretty

      - name: Run tests
        run: |
          xcodebuild \
            -workspace OnlineBikeShopping.xcworkspace \
            -scheme OnlineBikeShopping \
            -destination "id=${DEVICE_ID}" \
            test | xcpretty
